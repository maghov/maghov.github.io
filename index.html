<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Counter App</title>
    <link rel="stylesheet" href="style.css">
    <!-- Chart.js for analytics visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>

<body>
    <!-- Admin Button (top-right corner) -->
    <button id="adminBtn" class="admin-btn" title="Admin Access">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"></path>
            <path d="M12 9V7a3 3 0 00-6 0v2"></path>
        </svg>
    </button>

    <main>
        <h1>Counter App</h1>

        <div class="app-layout">
            <!-- Main Content Area -->
            <div class="main-content">
                <div class="user-info">
                    <p>Welcome, <strong id="currentUser">Guest</strong>!</p>
                    <button id="changeUserBtn" class="change-user-btn">Change User</button>
                </div>

                <!-- Game Mode Selector -->
                <div class="game-mode-selector">
                    <button class="mode-btn active" data-mode="normal">
                        <span class="mode-icon">‚ôæÔ∏è</span>
                        <span class="mode-label">Normal Mode</span>
                    </button>
                    <button class="mode-btn" data-mode="challenge">
                        <span class="mode-icon">‚ö°</span>
                        <span class="mode-label">15s Challenge</span>
                    </button>
                </div>

                <div class="stats-container">
                    <div class="stat-box">
                        <div class="stat-label">Your Clicks</div>
                        <div class="stat-value" id="userCount">0</div>
                    </div>
                    <div class="stat-box global">
                        <div class="stat-label">Global Total</div>
                        <div class="stat-value" id="globalCount">0</div>
                    </div>
                </div>

                <!-- Today's Most Clicks -->
                <div class="todays-most-clicks">
                    <div class="todays-header">
                        <h3>Today's Most Clicks</h3>
                        <span class="todays-date" id="todaysDate"></span>
                    </div>
                    <div class="todays-podium" id="todaysPodium">
                        <p class="loading-today">Loading today's stats...</p>
                    </div>
                </div>

                <!-- Challenge Mode Stats -->
                <div id="challengeStats" class="challenge-stats" style="display: none;">
                    <div class="challenge-timer">
                        <div class="timer-label">Time Remaining</div>
                        <div class="timer-value" id="challengeTimer">15.0s</div>
                    </div>
                    <div class="challenge-score">
                        <div class="score-label">Challenge Score</div>
                        <div class="score-value" id="challengeScore">0</div>
                    </div>
                    <div class="challenge-best">
                        <div class="best-label">Your Best</div>
                        <div class="best-value" id="challengeBest">-</div>
                    </div>
                </div>

                <div class="counter">
                    <div id="countBtn" class="circle">
                        <span class="click-text" id="clickText">CLICK</span>
                    </div>
                    <button id="startChallengeBtn" class="start-challenge-btn" style="display: none;">
                        Start Challenge
                    </button>
                </div>
            </div>

            <!-- Leaderboard Sidebar -->
            <div class="leaderboard-section">
                <div class="leaderboard-tabs">
                    <button class="leaderboard-tab active" data-tab="normal">Normal Mode</button>
                    <button class="leaderboard-tab" data-tab="challenge">15s Challenge</button>
                </div>

                <!-- Normal Leaderboard -->
                <div id="normalLeaderboardContent" class="leaderboard-content">
                    <h2>User Leaderboard</h2>
                    <p class="leaderboard-subtitle">Top Clickers</p>
                    <div id="leaderboard" class="leaderboard">
                        <p class="loading">Loading leaderboard...</p>
                    </div>
                </div>

                <!-- Challenge Leaderboard -->
                <div id="challengeLeaderboardContent" class="leaderboard-content" style="display: none;">
                    <h2>Challenge Leaderboard</h2>
                    <p class="leaderboard-subtitle">Top 15s Scores</p>
                    <div id="challengeLeaderboard" class="leaderboard">
                        <p class="loading">Loading challenge leaderboard...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Login Modal -->
        <div id="loginModal" class="modal" style="display: none;">
            <div class="modal-overlay" id="loginOverlay"></div>
            <div class="modal-content login-modal-content">
                <div class="modal-header">
                    <h2>Admin Login</h2>
                    <button class="modal-close" id="closeLoginModal">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="loginForm">
                        <div class="form-group">
                            <label for="adminEmail">Email</label>
                            <input type="email" id="adminEmail" required autocomplete="email" placeholder="admin@example.com">
                        </div>
                        <div class="form-group">
                            <label for="adminPassword">Password</label>
                            <input type="password" id="adminPassword" required autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        </div>
                        <div id="loginError" class="error-message" style="display: none;"></div>
                        <button type="submit" class="btn-primary">Login</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Admin Panel Modal -->
        <div id="adminPanel" class="modal" style="display: none;">
            <div class="modal-overlay" id="adminOverlay"></div>
            <div class="modal-content admin-panel-content">
                <div class="modal-header">
                    <h2>Admin Panel</h2>
                    <div class="admin-header-actions">
                        <button class="btn-secondary" id="logoutBtn">Logout</button>
                        <button class="modal-close" id="closeAdminPanel">&times;</button>
                    </div>
                </div>
                <div class="modal-body">
                    <!-- Statistics Section -->
                    <div class="admin-section">
                        <h3>Statistics Overview</h3>
                        <div class="admin-stats-grid">
                            <div class="admin-stat-card">
                                <div class="admin-stat-label">Total Users</div>
                                <div class="admin-stat-value" id="adminTotalUsers">0</div>
                                <div class="admin-stat-change" id="usersChange">-</div>
                            </div>
                            <div class="admin-stat-card">
                                <div class="admin-stat-label">Total Clicks</div>
                                <div class="admin-stat-value" id="adminTotalClicks">0</div>
                                <div class="admin-stat-change" id="clicksChange">-</div>
                            </div>
                            <div class="admin-stat-card">
                                <div class="admin-stat-label">Average Clicks</div>
                                <div class="admin-stat-value" id="adminAvgClicks">0</div>
                                <div class="admin-stat-change" id="avgChange">-</div>
                            </div>
                            <div class="admin-stat-card">
                                <div class="admin-stat-label">Most Active User</div>
                                <div class="admin-stat-value" id="adminTopUser">-</div>
                                <div class="admin-stat-change" id="topUserClicks">-</div>
                            </div>
                        </div>
                    </div>

                    <!-- Analytics Dashboard Section -->
                    <div class="admin-section">
                        <h3>Analytics Dashboard</h3>
                        <div class="analytics-container">
                            <div class="chart-container">
                                <h4>Click Distribution</h4>
                                <canvas id="clickDistributionChart"></canvas>
                            </div>
                            <div class="chart-container">
                                <h4>Top 10 Users</h4>
                                <canvas id="topUsersChart"></canvas>
                            </div>
                            <div class="chart-container chart-full-width">
                                <h4>Activity Timeline (Last 24 Hours)</h4>
                                <canvas id="activityTimelineChart"></canvas>
                            </div>
                            <div class="chart-container chart-full-width">
                                <h4>Growth Metrics</h4>
                                <canvas id="growthChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Activity Logs Section -->
                    <div class="admin-section">
                        <h3>Activity Logs</h3>
                        <div class="log-tabs">
                            <button class="log-tab active" data-tab="suspicious">Suspicious Activity</button>
                            <button class="log-tab" data-tab="login">Login Attempts</button>
                            <button class="log-tab" data-tab="all">All Activity</button>
                        </div>
                        <div class="log-filters">
                            <button class="btn-small" id="refreshLogsBtn">Refresh</button>
                            <button class="btn-small" id="clearLogsBtn">Clear Logs</button>
                        </div>
                        <div id="activityLogsContainer" class="activity-logs">
                            <p class="loading">Loading activity logs...</p>
                        </div>
                    </div>

                    <!-- User Management Section -->
                    <div class="admin-section">
                        <h3>User Management</h3>
                        <div class="admin-actions">
                            <button class="btn-danger" id="resetAllBtn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 12a9 9 0 0118 0 9 9 0 01-18 0z"></path>
                                </svg>
                                Reset All Counts
                            </button>
                        </div>
                        <div id="userListContainer" class="user-list">
                            <!-- User list will be dynamically populated -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-analytics.js";
        import { getDatabase, ref, set, child, get, increment, update, remove }
            from "https://www.gstatic.com/firebasejs/9.19.1/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged }
            from "https://www.gstatic.com/firebasejs/9.19.1/firebase-auth.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBIy7mb_wS05I_0ICLMSX1P5avFim7yXsA",
            authDomain: "chat-gtp-b0e1d.firebaseapp.com",
            databaseURL: "https://chat-gtp-b0e1d-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "chat-gtp-b0e1d",
            storageBucket: "chat-gtp-b0e1d.appspot.com",
            messagingSenderId: "617084173940",
            appId: "1:617084173940:web:e66612d6dae0337d4e9b21",
            measurementId: "G-TFJ234R5B9"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getDatabase();
        const auth = getAuth(app);

        // Current user
        let currentUser = null;
        let isAdmin = false;

        // Spam detection variables
        let clickHistory = [];
        const SPAM_THRESHOLD = 10; // clicks per second
        const SPAM_WINDOW = 1000; // 1 second

        // Challenge mode variables
        let currentMode = 'normal';
        let challengeActive = false;
        let challengeScore = 0;
        let challengeTimer = null;
        let challengeStartTime = null;
        const CHALLENGE_DURATION = 15000; // 15 seconds

        /**
         * Returns today's date as YYYY-MM-DD string
         */
        function getTodayKey() {
            const now = new Date();
            return now.getFullYear() + '-' +
                String(now.getMonth() + 1).padStart(2, '0') + '-' +
                String(now.getDate()).padStart(2, '0');
        }

        // Initialize app
        init();

        function init() {
            // Check if user exists in localStorage
            currentUser = localStorage.getItem('counterAppUser');

            if (!currentUser) {
                promptForUsername();
            } else {
                document.getElementById('currentUser').textContent = currentUser;
                loadUserData();
            }

            // Add event listeners
            document.getElementById('countBtn').addEventListener('click', handleClick);
            document.getElementById('changeUserBtn').addEventListener('click', changeUser);

            // Game mode event listeners
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    switchGameMode(e.target.closest('.mode-btn').dataset.mode);
                });
            });

            document.getElementById('startChallengeBtn').addEventListener('click', startChallenge);

            // Leaderboard tab listeners
            document.querySelectorAll('.leaderboard-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    switchLeaderboardTab(e.target.dataset.tab);
                });
            });

            // Load challenge best score
            loadChallengeBest();

            // Admin event listeners
            document.getElementById('adminBtn').addEventListener('click', showLoginModal);
            document.getElementById('closeLoginModal').addEventListener('click', hideLoginModal);
            document.getElementById('loginOverlay').addEventListener('click', hideLoginModal);
            document.getElementById('loginForm').addEventListener('submit', handleAdminLogin);
            document.getElementById('closeAdminPanel').addEventListener('click', hideAdminPanel);
            document.getElementById('adminOverlay').addEventListener('click', hideAdminPanel);
            document.getElementById('logoutBtn').addEventListener('click', handleAdminLogout);
            document.getElementById('resetAllBtn').addEventListener('click', resetAllUsers);

            // Note: Log tab event listeners are added dynamically when admin panel opens

            // Load global count, leaderboard, and today's clicks
            loadGlobalCount();
            loadLeaderboard();
            loadTodaysMostClicks();

            // Auth state listener
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    isAdmin = true;
                } else {
                    isAdmin = false;
                    hideAdminPanel();
                }
            });
        }

        /**
         * Prompts user to enter their username
         */
        function promptForUsername() {
            const userName = prompt("Welcome! Enter your name to start clicking:", "");

            if (userName && userName.trim() !== "") {
                currentUser = userName.trim();
                localStorage.setItem('counterAppUser', currentUser);
                document.getElementById('currentUser').textContent = currentUser;
                loadUserData();
            } else {
                currentUser = "Guest_" + Math.floor(Math.random() * 10000);
                localStorage.setItem('counterAppUser', currentUser);
                document.getElementById('currentUser').textContent = currentUser;
                loadUserData();
            }
        }

        /**
         * Allows user to change their username
         */
        function changeUser() {
            localStorage.removeItem('counterAppUser');
            promptForUsername();
        }

        /**
         * Loads the current user's click count
         */
        function loadUserData() {
            const dbRef = ref(getDatabase());

            get(child(dbRef, `users/${currentUser}/clicks`)).then((snapshot) => {
                const userCount = snapshot.exists() ? snapshot.val() : 0;
                document.getElementById('userCount').textContent = userCount;
            }).catch((error) => {
                console.error('Error loading user data:', error);
                document.getElementById('userCount').textContent = '0';
            });
        }

        /**
         * Loads the global total click count
         */
        function loadGlobalCount() {
            const dbRef = ref(getDatabase());

            get(child(dbRef, 'globalStats/totalClicks')).then((snapshot) => {
                const globalCount = snapshot.exists() ? snapshot.val() : 0;
                document.getElementById('globalCount').textContent = globalCount;
            }).catch((error) => {
                console.error('Error loading global count:', error);
            });
        }

        /**
         * Handles click on the counter button
         */
        async function handleClick() {
            // Challenge mode - just count clicks locally
            if (currentMode === 'challenge' && challengeActive) {
                challengeScore++;
                document.getElementById('challengeScore').textContent = challengeScore;
                return;
            }

            // Normal mode - save to database
            if (currentMode !== 'normal') return;

            try {
                // Spam detection
                const now = Date.now();
                clickHistory.push(now);

                // Remove clicks outside the spam window
                clickHistory = clickHistory.filter(time => now - time < SPAM_WINDOW);

                // Check for spam
                const isSpam = clickHistory.length > SPAM_THRESHOLD;

                if (isSpam) {
                    // Log suspicious activity
                    await logActivity('spam', {
                        user: currentUser,
                        clicksPerSecond: clickHistory.length,
                        message: `Rapid clicking detected: ${clickHistory.length} clicks in 1 second`
                    });
                }

                // Update user's click count
                const userRef = ref(db, `users/${currentUser}`);
                const userSnapshot = await get(userRef);

                let newUserCount = 1;
                if (userSnapshot.exists()) {
                    newUserCount = (userSnapshot.val().clicks || 0) + 1;
                }

                const updates = {};
                updates[`users/${currentUser}/clicks`] = newUserCount;
                updates[`users/${currentUser}/lastClick`] = new Date().toISOString();
                updates[`users/${currentUser}/userName`] = currentUser;

                // Update global count
                const globalRef = ref(db, 'globalStats/totalClicks');
                const globalSnapshot = await get(globalRef);
                const newGlobalCount = (globalSnapshot.exists() ? globalSnapshot.val() : 0) + 1;
                updates['globalStats/totalClicks'] = newGlobalCount;
                updates['globalStats/lastUpdated'] = new Date().toISOString();

                // Track daily clicks
                const todayKey = getTodayKey();
                const dailyRef = ref(db, `dailyClicks/${todayKey}/${currentUser}/clicks`);
                const dailySnapshot = await get(dailyRef);
                const newDailyCount = (dailySnapshot.exists() ? dailySnapshot.val() : 0) + 1;
                updates[`dailyClicks/${todayKey}/${currentUser}/clicks`] = newDailyCount;
                updates[`dailyClicks/${todayKey}/${currentUser}/userName`] = currentUser;
                updates[`dailyClicks/${todayKey}/${currentUser}/lastClick`] = new Date().toISOString();

                // Save to Firebase
                await update(ref(db), updates);

                // Update UI
                document.getElementById('userCount').textContent = newUserCount;
                document.getElementById('globalCount').textContent = newGlobalCount;

                // Refresh leaderboard and today's clicks
                loadLeaderboard();
                loadTodaysMostClicks();

                // Log normal activity periodically (every 10th click)
                if (newUserCount % 10 === 0) {
                    await logActivity('click', {
                        user: currentUser,
                        totalClicks: newUserCount,
                        message: `Reached ${newUserCount} clicks`
                    });
                }

                console.log(`User: ${currentUser}, Clicks: ${newUserCount}, Global: ${newGlobalCount}`);
            } catch (error) {
                console.error('Error handling click:', error);
            }
        }

        /**
         * Loads and displays the leaderboard
         */
        function loadLeaderboard() {
            const dbRef = ref(getDatabase());
            const leaderboardDiv = document.getElementById('leaderboard');

            get(child(dbRef, 'users')).then((snapshot) => {
                if (snapshot.exists()) {
                    const users = [];

                    snapshot.forEach((childSnapshot) => {
                        const data = childSnapshot.val();
                        if (data.clicks) {
                            users.push({
                                userName: data.userName || childSnapshot.key,
                                clicks: data.clicks,
                                lastClick: data.lastClick
                            });
                        }
                    });

                    // Sort by clicks (descending)
                    users.sort((a, b) => b.clicks - a.clicks);

                    // Display leaderboard
                    displayLeaderboard(users);
                } else {
                    leaderboardDiv.innerHTML = '<p class="no-data">No clicks yet. Be the first!</p>';
                }
            }).catch((error) => {
                console.error('Error loading leaderboard:', error);
                leaderboardDiv.innerHTML = '<p class="error">Error loading leaderboard</p>';
            });
        }

        /**
         * Displays the leaderboard entries
         * @param {Array} users - Array of user objects
         */
        function displayLeaderboard(users) {
            const leaderboardDiv = document.getElementById('leaderboard');

            if (users.length === 0) {
                leaderboardDiv.innerHTML = '<p class="no-data">No clicks yet. Be the first!</p>';
                return;
            }

            let html = '<table class="leaderboard-table"><thead><tr><th>Rank</th><th>User</th><th>Clicks</th><th>Last Click</th></tr></thead><tbody>';

            users.forEach((user, index) => {
                const date = new Date(user.lastClick);
                const formattedDate = date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const rankClass = index === 0 ? 'rank-1' : index === 1 ? 'rank-2' : index === 2 ? 'rank-3' : '';
                const isCurrentUser = user.userName === currentUser ? 'current-user' : '';

                html += `
                    <tr class="${rankClass} ${isCurrentUser}">
                        <td class="rank">${index + 1}</td>
                        <td class="name">${user.userName}${user.userName === currentUser ? ' (You)' : ''}</td>
                        <td class="clicks">${user.clicks}</td>
                        <td class="date">${formattedDate}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            leaderboardDiv.innerHTML = html;
        }

        /**
         * Logs activity to Firebase
         */
        async function logActivity(type, data) {
            try {
                const timestamp = Date.now();
                const logEntry = {
                    type: type,
                    timestamp: timestamp,
                    date: new Date().toISOString(),
                    ...data
                };

                // Store in Firebase under activityLogs
                const logRef = ref(db, `activityLogs/${timestamp}`);
                await set(logRef, logEntry);
            } catch (error) {
                console.error('Error logging activity:', error);
            }
        }

        /**
         * Switch between game modes
         */
        function switchGameMode(mode) {
            currentMode = mode;

            // Update mode buttons
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });

            if (mode === 'normal') {
                // Show normal mode UI
                document.querySelector('.stats-container').style.display = 'flex';
                document.querySelector('.todays-most-clicks').style.display = 'block';
                document.getElementById('challengeStats').style.display = 'none';
                document.getElementById('startChallengeBtn').style.display = 'none';
                document.getElementById('countBtn').style.display = 'flex';
                document.getElementById('clickText').textContent = 'CLICK';
            } else if (mode === 'challenge') {
                // Show challenge mode UI
                document.querySelector('.stats-container').style.display = 'none';
                document.querySelector('.todays-most-clicks').style.display = 'none';
                document.getElementById('challengeStats').style.display = 'grid';
                document.getElementById('startChallengeBtn').style.display = 'block';
                document.getElementById('countBtn').style.display = 'none';
                document.getElementById('challengeTimer').textContent = '15.0s';
                document.getElementById('challengeScore').textContent = '0';
            }
        }

        /**
         * Switch between leaderboard tabs
         */
        function switchLeaderboardTab(tab) {
            document.querySelectorAll('.leaderboard-tab').forEach(t => {
                t.classList.toggle('active', t.dataset.tab === tab);
            });

            if (tab === 'normal') {
                document.getElementById('normalLeaderboardContent').style.display = 'block';
                document.getElementById('challengeLeaderboardContent').style.display = 'none';
            } else {
                document.getElementById('normalLeaderboardContent').style.display = 'none';
                document.getElementById('challengeLeaderboardContent').style.display = 'block';
                loadChallengeLeaderboard();
            }
        }

        /**
         * Start challenge mode
         */
        function startChallenge() {
            challengeActive = true;
            challengeScore = 0;
            challengeStartTime = Date.now();

            // Hide start button, show click button
            document.getElementById('startChallengeBtn').style.display = 'none';
            document.getElementById('countBtn').style.display = 'flex';
            document.getElementById('clickText').textContent = 'GO!';
            document.getElementById('challengeScore').textContent = '0';

            // Start timer
            updateChallengeTimer();
            challengeTimer = setInterval(updateChallengeTimer, 50);

            // End challenge after duration
            setTimeout(endChallenge, CHALLENGE_DURATION);
        }

        /**
         * Update challenge timer display
         */
        function updateChallengeTimer() {
            const elapsed = Date.now() - challengeStartTime;
            const remaining = Math.max(0, (CHALLENGE_DURATION - elapsed) / 1000);
            document.getElementById('challengeTimer').textContent = remaining.toFixed(1) + 's';

            // Change color as time runs out
            const timerEl = document.getElementById('challengeTimer');
            if (remaining < 5) {
                timerEl.style.color = '#f56565';
            } else if (remaining < 10) {
                timerEl.style.color = '#ed8936';
            } else {
                timerEl.style.color = '#667eea';
            }
        }

        /**
         * End challenge mode
         */
        async function endChallenge() {
            challengeActive = false;
            clearInterval(challengeTimer);

            document.getElementById('challengeTimer').textContent = '0.0s';
            document.getElementById('countBtn').style.display = 'none';
            document.getElementById('startChallengeBtn').style.display = 'block';
            document.getElementById('clickText').textContent = 'CLICK';

            // Save score to Firebase
            try {
                const scoreRef = ref(db, `challengeScores/${currentUser}`);
                const snapshot = await get(scoreRef);
                const currentBest = snapshot.exists() ? snapshot.val().score : 0;

                if (challengeScore > currentBest) {
                    await set(scoreRef, {
                        userName: currentUser,
                        score: challengeScore,
                        date: new Date().toISOString()
                    });

                    alert(`üéâ New Personal Best! You scored ${challengeScore} clicks in 15 seconds!`);
                    document.getElementById('challengeBest').textContent = challengeScore;
                    loadChallengeLeaderboard();
                } else {
                    alert(`Challenge Complete! You scored ${challengeScore} clicks. Your best: ${currentBest}`);
                }
            } catch (error) {
                console.error('Error saving challenge score:', error);
                alert(`Challenge Complete! You scored ${challengeScore} clicks!`);
            }
        }

        /**
         * Load user's best challenge score
         */
        async function loadChallengeBest() {
            try {
                const scoreRef = ref(db, `challengeScores/${currentUser}`);
                const snapshot = await get(scoreRef);

                if (snapshot.exists()) {
                    document.getElementById('challengeBest').textContent = snapshot.val().score;
                } else {
                    document.getElementById('challengeBest').textContent = '-';
                }
            } catch (error) {
                console.error('Error loading challenge best:', error);
            }
        }

        /**
         * Load challenge leaderboard
         */
        async function loadChallengeLeaderboard() {
            const leaderboardDiv = document.getElementById('challengeLeaderboard');
            leaderboardDiv.innerHTML = '<p class="loading">Loading...</p>';

            try {
                const dbRef = ref(getDatabase());
                const snapshot = await get(child(dbRef, 'challengeScores'));

                if (snapshot.exists()) {
                    const scores = [];

                    snapshot.forEach((childSnapshot) => {
                        const data = childSnapshot.val();
                        scores.push({
                            userName: data.userName || childSnapshot.key,
                            score: data.score,
                            date: data.date
                        });
                    });

                    // Sort by score descending
                    scores.sort((a, b) => b.score - a.score);

                    // Build table
                    let tableHTML = `
                        <table class="leaderboard-table">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>User</th>
                                    <th>Score</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    scores.forEach((entry, index) => {
                        const rank = index + 1;
                        const isCurrentUser = entry.userName === currentUser;
                        const rowClass = isCurrentUser ? 'current-user' :
                                        (rank === 1 ? 'rank-1' :
                                        (rank === 2 ? 'rank-2' :
                                        (rank === 3 ? 'rank-3' : '')));

                        const date = new Date(entry.date).toLocaleDateString('en-US', {
                            month: 'short',
                            day: 'numeric'
                        });

                        tableHTML += `
                            <tr class="${rowClass}">
                                <td class="rank">${rank}</td>
                                <td class="user">${entry.userName}${isCurrentUser ? ' (You)' : ''}</td>
                                <td class="clicks">${entry.score}</td>
                                <td class="date">${date}</td>
                            </tr>
                        `;
                    });

                    tableHTML += '</tbody></table>';
                    leaderboardDiv.innerHTML = tableHTML;
                } else {
                    leaderboardDiv.innerHTML = '<p style="text-align: center; color: #a0aec0; padding: 30px;">No challenge scores yet. Be the first!</p>';
                }
            } catch (error) {
                console.error('Error loading challenge leaderboard:', error);
                leaderboardDiv.innerHTML = '<p class="error">Error loading leaderboard</p>';
            }
        }

        /**
         * Loads and displays today's most clicks
         */
        async function loadTodaysMostClicks() {
            const podiumDiv = document.getElementById('todaysPodium');
            const dateSpan = document.getElementById('todaysDate');
            const todayKey = getTodayKey();

            // Display today's date
            const today = new Date();
            dateSpan.textContent = today.toLocaleDateString('en-US', {
                weekday: 'long',
                month: 'short',
                day: 'numeric'
            });

            try {
                const dbRef = ref(getDatabase());
                const snapshot = await get(child(dbRef, `dailyClicks/${todayKey}`));

                if (snapshot.exists()) {
                    const users = [];

                    snapshot.forEach((childSnapshot) => {
                        const data = childSnapshot.val();
                        if (data.clicks) {
                            users.push({
                                userName: data.userName || childSnapshot.key,
                                clicks: data.clicks,
                                lastClick: data.lastClick
                            });
                        }
                    });

                    // Sort by clicks descending
                    users.sort((a, b) => b.clicks - a.clicks);

                    if (users.length === 0) {
                        podiumDiv.innerHTML = '<p class="no-clicks-today">No clicks yet today. Be the first!</p>';
                        return;
                    }

                    // Build podium display (top 3) and list for the rest
                    let html = '<div class="podium-cards">';

                    users.slice(0, 3).forEach((user, index) => {
                        const medals = ['gold', 'silver', 'bronze'];
                        const medalIcons = ['&#x1F947;', '&#x1F948;', '&#x1F949;'];
                        const isYou = user.userName === currentUser;

                        html += `
                            <div class="podium-card ${medals[index]}${isYou ? ' is-you' : ''}">
                                <div class="podium-medal">${medalIcons[index]}</div>
                                <div class="podium-name">${user.userName}${isYou ? ' (You)' : ''}</div>
                                <div class="podium-clicks">${user.clicks}</div>
                                <div class="podium-label">clicks today</div>
                            </div>
                        `;
                    });

                    html += '</div>';

                    // Show remaining users in a compact list
                    if (users.length > 3) {
                        html += '<div class="todays-rest">';
                        users.slice(3, 10).forEach((user, index) => {
                            const isYou = user.userName === currentUser;
                            html += `
                                <div class="todays-rest-item${isYou ? ' is-you' : ''}">
                                    <span class="todays-rest-rank">${index + 4}.</span>
                                    <span class="todays-rest-name">${user.userName}${isYou ? ' (You)' : ''}</span>
                                    <span class="todays-rest-clicks">${user.clicks}</span>
                                </div>
                            `;
                        });
                        html += '</div>';
                    }

                    podiumDiv.innerHTML = html;
                } else {
                    podiumDiv.innerHTML = '<p class="no-clicks-today">No clicks yet today. Be the first!</p>';
                }
            } catch (error) {
                console.error('Error loading today\'s clicks:', error);
                podiumDiv.innerHTML = '<p class="error">Error loading today\'s clicks</p>';
            }
        }

        /**
         * Shows the login modal
         */
        function showLoginModal() {
            const modal = document.getElementById('loginModal');
            modal.style.display = 'flex';
            document.getElementById('adminEmail').focus();
            document.getElementById('loginError').style.display = 'none';
            document.getElementById('loginForm').reset();
        }

        /**
         * Hides the login modal
         */
        function hideLoginModal() {
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('loginForm').reset();
            document.getElementById('loginError').style.display = 'none';
        }

        /**
         * Handles admin login form submission
         */
        async function handleAdminLogin(event) {
            event.preventDefault();

            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;
            const errorDiv = document.getElementById('loginError');

            try {
                await signInWithEmailAndPassword(auth, email, password);

                // Log successful login
                await logActivity('login-success', {
                    email: email,
                    message: 'Admin login successful'
                });

                hideLoginModal();
                showAdminPanel();
            } catch (error) {
                console.error('Login error:', error);

                // Log failed login attempt
                await logActivity('login-failed', {
                    email: email,
                    error: error.code,
                    message: `Failed login attempt: ${error.code}`
                });

                // Map Firebase error codes to user-friendly messages
                const errorMessages = {
                    'auth/wrong-password': 'Incorrect password',
                    'auth/user-not-found': 'No admin account found',
                    'auth/invalid-email': 'Invalid email address',
                    'auth/too-many-requests': 'Too many attempts. Try again later',
                    'auth/invalid-credential': 'Invalid email or password'
                };

                const message = errorMessages[error.code] || 'Login failed. Please try again.';
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            }
        }

        /**
         * Handles admin logout
         */
        async function handleAdminLogout() {
            try {
                await signOut(auth);
                hideAdminPanel();
            } catch (error) {
                console.error('Logout error:', error);
                alert('Error logging out. Please try again.');
            }
        }

        /**
         * Shows the admin panel
         */
        function showAdminPanel() {
            const panel = document.getElementById('adminPanel');
            panel.style.display = 'flex';
            loadAdminStatistics();
            loadUserList();
            loadActivityLogs('suspicious');
            loadAnalyticsDashboard();

            // Add event listeners for log tabs
            document.querySelectorAll('.log-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    document.querySelectorAll('.log-tab').forEach(t => t.classList.remove('active'));
                    e.target.classList.add('active');
                    loadActivityLogs(e.target.dataset.tab);
                });
            });

            // Add event listeners for log actions
            document.getElementById('refreshLogsBtn').addEventListener('click', () => {
                const activeTab = document.querySelector('.log-tab.active').dataset.tab;
                loadActivityLogs(activeTab);
            });

            document.getElementById('clearLogsBtn').addEventListener('click', clearActivityLogs);
        }

        /**
         * Hides the admin panel
         */
        function hideAdminPanel() {
            const panel = document.getElementById('adminPanel');
            if (panel) {
                panel.style.display = 'none';
            }
        }

        /**
         * Checks if the current user is an authorized admin
         * @param {Object} user - Firebase auth user object
         * @returns {boolean} - True if authorized admin
         */
        function isAuthorizedAdmin(user) {
            const ADMIN_EMAIL = 'maghovk@gmail.com'; // REPLACE WITH YOUR ADMIN EMAIL
            return user && user.email === ADMIN_EMAIL;
        }

        /**
         * Loads and displays admin statistics
         */
        async function loadAdminStatistics() {
            const dbRef = ref(getDatabase());

            try {
                const snapshot = await get(child(dbRef, 'users'));

                if (snapshot.exists()) {
                    const users = [];
                    let totalClicks = 0;
                    let topUser = { name: '-', clicks: 0 };

                    snapshot.forEach((childSnapshot) => {
                        const data = childSnapshot.val();
                        if (data.clicks) {
                            users.push({
                                userName: data.userName || childSnapshot.key,
                                clicks: data.clicks
                            });
                            totalClicks += data.clicks;

                            if (data.clicks > topUser.clicks) {
                                topUser = {
                                    name: data.userName || childSnapshot.key,
                                    clicks: data.clicks
                                };
                            }
                        }
                    });

                    const totalUsers = users.length;
                    const avgClicks = totalUsers > 0 ? Math.round(totalClicks / totalUsers) : 0;

                    // Update DOM
                    document.getElementById('adminTotalUsers').textContent = totalUsers;
                    document.getElementById('adminTotalClicks').textContent = totalClicks;
                    document.getElementById('adminAvgClicks').textContent = avgClicks;
                    document.getElementById('adminTopUser').textContent = topUser.name;
                } else {
                    // No users yet
                    document.getElementById('adminTotalUsers').textContent = '0';
                    document.getElementById('adminTotalClicks').textContent = '0';
                    document.getElementById('adminAvgClicks').textContent = '0';
                    document.getElementById('adminTopUser').textContent = '-';
                }
            } catch (error) {
                console.error('Error loading admin statistics:', error);
            }
        }

        /**
         * Loads and displays the user list with delete buttons
         */
        async function loadUserList() {
            const dbRef = ref(getDatabase());
            const container = document.getElementById('userListContainer');

            try {
                const snapshot = await get(child(dbRef, 'users'));

                if (snapshot.exists()) {
                    const users = [];

                    snapshot.forEach((childSnapshot) => {
                        const data = childSnapshot.val();
                        if (data.clicks) {
                            users.push({
                                userName: data.userName || childSnapshot.key,
                                clicks: data.clicks,
                                lastClick: data.lastClick
                            });
                        }
                    });

                    // Sort by clicks descending
                    users.sort((a, b) => b.clicks - a.clicks);

                    // Build HTML
                    let html = '';
                    users.forEach(user => {
                        const lastClickDate = new Date(user.lastClick).toLocaleDateString('en-US', {
                            month: 'short',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });

                        html += `
                            <div class="user-item">
                                <div class="user-item-info">
                                    <div class="user-item-name">${user.userName}</div>
                                    <div class="user-item-stats">${user.clicks} clicks ‚Ä¢ Last: ${lastClickDate}</div>
                                </div>
                                <div class="user-item-actions">
                                    <button class="btn-small" onclick="removeUser('${user.userName}')">Delete</button>
                                </div>
                            </div>
                        `;
                    });

                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<p style="text-align: center; color: #718096; padding: 20px;">No users yet</p>';
                }
            } catch (error) {
                console.error('Error loading user list:', error);
                container.innerHTML = '<p style="text-align: center; color: #e53e3e; padding: 20px;">Error loading users</p>';
            }
        }

        /**
         * Resets all user click counts to 0
         */
        async function resetAllUsers() {
            const user = auth.currentUser;
            if (!isAuthorizedAdmin(user)) {
                alert('Unauthorized access');
                return;
            }

            if (!confirm('Are you sure you want to reset all user counts? This cannot be undone.')) {
                return;
            }

            try {
                const dbRef = ref(getDatabase());
                const snapshot = await get(child(dbRef, 'users'));

                if (snapshot.exists()) {
                    const updates = {};

                    // Set all users' clicks to 0
                    snapshot.forEach((childSnapshot) => {
                        updates[`users/${childSnapshot.key}/clicks`] = 0;
                    });

                    // Reset global stats
                    updates['globalStats/totalClicks'] = 0;
                    updates['globalStats/lastUpdated'] = new Date().toISOString();

                    // Apply updates
                    await update(ref(db), updates);

                    // Refresh UI
                    loadAdminStatistics();
                    loadUserList();
                    loadGlobalCount();
                    loadLeaderboard();

                    alert('All user counts have been reset to 0');
                } else {
                    alert('No users to reset');
                }
            } catch (error) {
                console.error('Error resetting users:', error);
                alert('Error resetting users. Please try again.');
            }
        }

        /**
         * Removes a specific user from the database
         * @param {string} userName - The username to remove
         */
        async function removeUser(userName) {
            const user = auth.currentUser;
            if (!isAuthorizedAdmin(user)) {
                alert('Unauthorized access');
                return;
            }

            if (!confirm(`Are you sure you want to delete ${userName}? This cannot be undone.`)) {
                return;
            }

            try {
                const dbRef = ref(getDatabase());

                // Get user's click count first
                const userSnapshot = await get(child(dbRef, `users/${userName}`));

                if (userSnapshot.exists()) {
                    const userClicks = userSnapshot.val().clicks || 0;

                    // Delete user
                    await remove(ref(db, `users/${userName}`));

                    // Update global stats
                    const globalSnapshot = await get(child(dbRef, 'globalStats/totalClicks'));
                    const currentGlobalTotal = globalSnapshot.exists() ? globalSnapshot.val() : 0;
                    const newGlobalTotal = Math.max(0, currentGlobalTotal - userClicks);

                    const updates = {};
                    updates['globalStats/totalClicks'] = newGlobalTotal;
                    updates['globalStats/lastUpdated'] = new Date().toISOString();

                    await update(ref(db), updates);

                    // Refresh UI
                    loadAdminStatistics();
                    loadUserList();
                    loadGlobalCount();
                    loadLeaderboard();

                    alert(`User ${userName} has been deleted`);
                } else {
                    alert('User not found');
                }
            } catch (error) {
                console.error('Error removing user:', error);
                alert('Error removing user. Please try again.');
            }
        }

        /**
         * Loads and displays activity logs
         */
        async function loadActivityLogs(filter = 'all') {
            const container = document.getElementById('activityLogsContainer');
            container.innerHTML = '<p class="loading">Loading activity logs...</p>';

            try {
                const dbRef = ref(getDatabase());
                const snapshot = await get(child(dbRef, 'activityLogs'));

                if (snapshot.exists()) {
                    const logs = [];

                    snapshot.forEach((childSnapshot) => {
                        const log = childSnapshot.val();
                        logs.push(log);
                    });

                    // Sort by timestamp (newest first)
                    logs.sort((a, b) => b.timestamp - a.timestamp);

                    // Filter logs based on selected tab
                    let filteredLogs = logs;
                    if (filter === 'suspicious') {
                        filteredLogs = logs.filter(log => log.type === 'spam' || log.type === 'suspicious');
                    } else if (filter === 'login') {
                        filteredLogs = logs.filter(log => log.type === 'login-success' || log.type === 'login-failed');
                    }

                    // Display logs
                    if (filteredLogs.length === 0) {
                        let message = 'No logs found';
                        if (filter === 'suspicious') {
                            message = 'No suspicious activity detected. Click the counter button rapidly to test spam detection.';
                        } else if (filter === 'login') {
                            message = 'No login attempts recorded yet.';
                        }
                        container.innerHTML = `<p style="text-align: center; color: #718096; padding: 20px;">${message}</p>`;
                        return;
                    }

                    let html = '';
                    filteredLogs.forEach(log => {
                        const logClass = log.type;
                        const date = new Date(log.date);
                        const timeStr = date.toLocaleString();

                        let typeLabel = '';
                        let badge = '';

                        switch(log.type) {
                            case 'spam':
                                typeLabel = '‚ö†Ô∏è Spam Detection';
                                badge = '<span class="log-badge danger">SPAM</span>';
                                break;
                            case 'login-success':
                                typeLabel = '‚úÖ Login Success';
                                badge = '<span class="log-badge info">SUCCESS</span>';
                                break;
                            case 'login-failed':
                                typeLabel = '‚ùå Login Failed';
                                badge = '<span class="log-badge warning">FAILED</span>';
                                break;
                            case 'click':
                                typeLabel = 'üñ±Ô∏è Milestone';
                                badge = '<span class="log-badge info">INFO</span>';
                                break;
                            default:
                                typeLabel = 'üìù Activity';
                                badge = '<span class="log-badge info">INFO</span>';
                        }

                        html += `
                            <div class="log-entry ${logClass}">
                                <div class="log-entry-header">
                                    <div class="log-entry-type">${typeLabel}${badge}</div>
                                    <div class="log-entry-time">${timeStr}</div>
                                </div>
                                <div class="log-entry-details">
                                    ${log.user ? `<span class="log-entry-user">${log.user}</span>: ` : ''}
                                    ${log.email ? `<span class="log-entry-user">${log.email}</span>: ` : ''}
                                    ${log.message}
                                </div>
                            </div>
                        `;
                    });

                    container.innerHTML = html;
                } else {
                    // No logs exist at all
                    let message = 'No activity logs yet. Logs are automatically created when:<br>' +
                                '‚Ä¢ Users click the counter button (every 10th click)<br>' +
                                '‚Ä¢ Spam is detected (rapid clicking)<br>' +
                                '‚Ä¢ Admin login attempts are made';
                    container.innerHTML = `<div style="text-align: center; color: #718096; padding: 20px;">${message}</div>`;
                }
            } catch (error) {
                console.error('Error loading activity logs:', error);
                console.error('Error details:', error.message, error.stack);
                container.innerHTML = `<p style="text-align: center; color: #e53e3e; padding: 20px;">Error loading logs: ${error.message}</p>`;
            }
        }

        /**
         * Clears all activity logs
         */
        async function clearActivityLogs() {
            if (!confirm('Are you sure you want to clear all activity logs? This cannot be undone.')) {
                return;
            }

            try {
                const logsRef = ref(db, 'activityLogs');
                await remove(logsRef);

                alert('Activity logs cleared successfully');
                loadActivityLogs('suspicious');
            } catch (error) {
                console.error('Error clearing logs:', error);
                alert('Error clearing logs. Please try again.');
            }
        }

        /**
         * Loads analytics dashboard with charts
         */
        let chartInstances = {};

        async function loadAnalyticsDashboard() {
            try {
                const dbRef = ref(getDatabase());
                const usersSnapshot = await get(child(dbRef, 'users'));
                const logsSnapshot = await get(child(dbRef, 'activityLogs'));

                if (!usersSnapshot.exists()) {
                    return;
                }

                const users = [];
                usersSnapshot.forEach((childSnapshot) => {
                    const data = childSnapshot.val();
                    if (data.clicks) {
                        users.push({
                            userName: data.userName || childSnapshot.key,
                            clicks: data.clicks,
                            lastClick: data.lastClick
                        });
                    }
                });

                users.sort((a, b) => b.clicks - a.clicks);

                // Load charts
                loadClickDistributionChart(users);
                loadTopUsersChart(users.slice(0, 10));
                loadActivityTimelineChart(logsSnapshot);
                loadGrowthChart(users, logsSnapshot);

            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        /**
         * Click Distribution Pie Chart
         */
        function loadClickDistributionChart(users) {
            const ctx = document.getElementById('clickDistributionChart');

            // Destroy existing chart if it exists
            if (chartInstances.clickDistribution) {
                chartInstances.clickDistribution.destroy();
            }

            const totalClicks = users.reduce((sum, u) => sum + u.clicks, 0);
            const top5 = users.slice(0, 5);
            const othersClicks = users.slice(5).reduce((sum, u) => sum + u.clicks, 0);

            const labels = [...top5.map(u => u.userName), 'Others'];
            const data = [...top5.map(u => u.clicks), othersClicks];

            chartInstances.clickDistribution = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#667eea',
                            '#764ba2',
                            '#f093fb',
                            '#f5576c',
                            '#4facfe',
                            '#cbd5e0'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'right'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const percentage = ((context.parsed / totalClicks) * 100).toFixed(1);
                                    return `${context.label}: ${context.parsed} clicks (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        /**
         * Top Users Bar Chart
         */
        function loadTopUsersChart(topUsers) {
            const ctx = document.getElementById('topUsersChart');

            if (chartInstances.topUsers) {
                chartInstances.topUsers.destroy();
            }

            chartInstances.topUsers = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: topUsers.map(u => u.userName),
                    datasets: [{
                        label: 'Clicks',
                        data: topUsers.map(u => u.clicks),
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: '#667eea',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }

        /**
         * Activity Timeline (Last 24 Hours)
         */
        function loadActivityTimelineChart(logsSnapshot) {
            const ctx = document.getElementById('activityTimelineChart');

            if (chartInstances.activityTimeline) {
                chartInstances.activityTimeline.destroy();
            }

            // Process logs for last 24 hours
            const now = Date.now();
            const last24Hours = now - (24 * 60 * 60 * 1000);
            const hourlyData = Array(24).fill(0);
            const hourlySpam = Array(24).fill(0);

            if (logsSnapshot.exists()) {
                logsSnapshot.forEach((childSnapshot) => {
                    const log = childSnapshot.val();
                    if (log.timestamp > last24Hours) {
                        const hoursAgo = Math.floor((now - log.timestamp) / (60 * 60 * 1000));
                        const index = 23 - hoursAgo;

                        if (index >= 0 && index < 24) {
                            if (log.type === 'click') {
                                hourlyData[index]++;
                            } else if (log.type === 'spam') {
                                hourlySpam[index]++;
                            }
                        }
                    }
                });
            }

            const labels = Array(24).fill(0).map((_, i) => {
                const hour = new Date(now - ((23 - i) * 60 * 60 * 1000));
                return hour.getHours() + ':00';
            });

            chartInstances.activityTimeline = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Click Activity',
                            data: hourlyData,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Spam Detected',
                            data: hourlySpam,
                            borderColor: '#fc8181',
                            backgroundColor: 'rgba(252, 129, 129, 0.1)',
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }

        /**
         * Growth Metrics Chart
         */
        function loadGrowthChart(users, logsSnapshot) {
            const ctx = document.getElementById('growthChart');

            if (chartInstances.growth) {
                chartInstances.growth.destroy();
            }

            // Simulate daily growth data from logs
            const days = 7;
            const dailyUsers = Array(days).fill(0);
            const dailyClicks = Array(days).fill(0);

            // In a real scenario, you'd track this in Firebase
            // For now, we'll estimate based on current data
            const now = Date.now();
            if (logsSnapshot.exists()) {
                logsSnapshot.forEach((childSnapshot) => {
                    const log = childSnapshot.val();
                    const daysAgo = Math.floor((now - log.timestamp) / (24 * 60 * 60 * 1000));
                    if (daysAgo >= 0 && daysAgo < days) {
                        const index = days - 1 - daysAgo;
                        if (log.type === 'click') {
                            dailyClicks[index]++;
                        }
                    }
                });
            }

            const labels = Array(days).fill(0).map((_, i) => {
                const date = new Date(now - ((days - 1 - i) * 24 * 60 * 60 * 1000));
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });

            chartInstances.growth = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Daily Milestones',
                            data: dailyClicks,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.2)',
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }

        // Expose removeUser to global scope for inline onclick handlers
        window.removeUser = removeUser;
    </script>

    <script src="script.js"></script>
</body>
</html>
